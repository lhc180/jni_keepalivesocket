#include "common_net_keepalive_LTSocketImpl.h"

#include <sys/socket.h>
#include <sys/types.h>
#include <linux/in.h>

#include <stdio.h>
#include <signal.h>


#include "SocketHolder.h"

static SocketHolder *mpSocketHolder = NULL;

JNIEXPORT jint JNICALL Java_common_net_keepalive_LTSocketImpl_init
  (JNIEnv * env, jobject obj)
{
  jclass cls = env->GetObjectClass (obj);
  jmethodID callback = env->GetMethodID (cls, "callback", "(II)V");
  env->CallVoidMethod (obj, callback, 5, 10);

  if (mpSocketHolder != NULL)
    {
      delete mpSocketHolder;
    }

  mpSocketHolder = new SocketHolder ();


}


/*
 * Class:     common_net_keepalive_LTSocketImpl
 * Method:    connect
 * Signature: (Ljava/lang/String;I)I
 */
JNIEXPORT jint JNICALL Java_common_net_keepalive_LTSocketImpl_connect
  (JNIEnv * env, jobject obj, jstring host, jint port)
{

  const char *cHost = env->GetStringUTFChars (host, 0);

  int result = mpSocketHolder->lt_connect (cHost, port);

  return result;

}

/*
 * Class:     common_net_keepalive_LTSocketImpl
 * Method:    send
 * Signature: ([BI)I
 */
JNIEXPORT jint JNICALL Java_common_net_keepalive_LTSocketImpl_send
  (JNIEnv * env, jobject obj, jbyteArray content, jint length)
{
  jbyte *olddata = (jbyte *) env->GetByteArrayElements (content, 0);
  jsize oldsize = env->GetArrayLength (content);
  char *bytearr = (char *) olddata;
  int result = mpSocketHolder->lt_send (bytearr, length);
  return result;

}

/*
 * Class:     common_net_keepalive_LTSocketImpl
 * Method:    readAsync
 * Signature: (Lcommon/net/keepalive/LTSocketImpl/ReadCallback;)I
 */
JNIEXPORT jint JNICALL Java_common_net_keepalive_LTSocketImpl_readSync
  (JNIEnv * env, jobject obj, jobject callback)
{
	char buffer[1024];
	  int result = mpSocketHolder->lt_readSync(buffer, 1024);

	  return result;

}


#ifdef __cplusplus
extern "C"
{
#endif

  void sigroutine (int dunno)
  {				/* 信号处理例程，其中dunno将会得到信号的值 */
    switch (dunno)
      {
      case 1:
	printf ("Get a signal -- SIGHUP ");
	break;
	case 2:printf ("Get a signal -- SIGINT ");
	break;
	case SIGPIPE:printf ("Get a signal -- SIGPIPE ");
	break;
      }
    return;
  }




#ifdef __cplusplus
}
#endif
